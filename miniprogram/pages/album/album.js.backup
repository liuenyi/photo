const app = getApp()

Page({
  data: {
    albumId: '',
    albumName: '',
    photos: [],
    loading: true,
    error: false,
    page: 1,
    hasMore: true,
    refreshing: false,
    previewIndex: 0,
    sortOptions: [
      { key: 'default', name: 'è‡ªå®šä¹‰æŽ’åº' },
      { key: 'created_at_desc', name: 'æœ€æ–°ä¸Šä¼ ' },
      { key: 'created_at_asc', name: 'æœ€æ—©ä¸Šä¼ ' },
      { key: 'filename_asc', name: 'æ–‡ä»¶åA-Z' },
      { key: 'filename_desc', name: 'æ–‡ä»¶åZ-A' }
    ],
    currentSort: 'default',
    showSortModal: false,
    initialized: false
  },

  onLoad(options) {
    if (options.albumId && !this.data.initialized) {
      this.setData({ 
        albumId: options.albumId,
        albumName: decodeURIComponent(options.albumName || 'ç›¸å†Œè¯¦æƒ…'),
        initialized: true
      })
      
      // è®¾ç½®é¡µé¢æ ‡é¢˜
      wx.setNavigationBarTitle({
        title: this.data.albumName
      })
      
      this.loadPhotos()
    } else if (!options.albumId) {
      app.showError('å‚æ•°é”™è¯¯')
      wx.navigateBack()
    }
  },

  onShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶ä¸è‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®
    // ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸‹æ‹‰åˆ·æ–°æ¥æ›´æ–°æ•°æ®
  },

  onPullDownRefresh() {
    this.refreshData()
  },

  onReachBottom() {
    if (this.data.hasMore && !this.data.loading) {
      this.loadMorePhotos()
    }
  },

  // åˆ·æ–°æ•°æ®
  async refreshData() {
    this.setData({ 
      refreshing: true,
      page: 1,
      hasMore: true,
      error: false
    })
    
    try {
      await this.loadPhotos(true)
      app.showSuccess('åˆ·æ–°æˆåŠŸ')
    } catch (error) {
      console.error('åˆ·æ–°å¤±è´¥:', error)
      app.showError('åˆ·æ–°å¤±è´¥')
    } finally {
      this.setData({ refreshing: false })
      wx.stopPullDownRefresh()
    }
  },

  // åŠ è½½ç…§ç‰‡åˆ—è¡¨
  async loadPhotos(isRefresh = false) {
    // å¦‚æžœä¸æ˜¯åˆ·æ–°æ“ä½œï¼Œå…ˆå°è¯•ä»Žç¼“å­˜åŠ è½½
    if (!isRefresh) {
      const cachedPhotos = app.cacheManager.getPhotosCache(this.data.albumId)
      if (cachedPhotos && cachedPhotos.length > 0) {
        console.log('ðŸ“¦ ä½¿ç”¨ç¼“å­˜çš„ç…§ç‰‡æ•°æ®', cachedPhotos.length, 'å¼ ç…§ç‰‡')
        this.setData({
          photos: cachedPhotos,
          loading: false,
          error: false
        })
        // å³ä½¿æœ‰ç¼“å­˜ï¼Œä¹Ÿåœ¨åŽå°æ›´æ–°æ•°æ®
        this.loadPhotosFromAPI(true)
        return
      }
    }
    
    // æ²¡æœ‰ç¼“å­˜æˆ–éœ€è¦åˆ·æ–°æ—¶ï¼Œä»ŽAPIåŠ è½½
    await this.loadPhotosFromAPI(isRefresh)
  },

  // ä»ŽAPIåŠ è½½ç…§ç‰‡æ•°æ®
  async loadPhotosFromAPI(isRefresh = false) {
    if (!isRefresh) {
      this.setData({ loading: true, error: false })
    }
    
    try {
      const response = await app.request({
        url: '/photos/',
        method: 'GET',
        data: {
          album_id: this.data.albumId,
          page: isRefresh ? 1 : this.data.page,
          size: 20,
          sort_by: this.data.currentSort
        }
      })

      console.log('ç…§ç‰‡APIå“åº”:', {
        response,
        albumId: this.data.albumId,
        isRefresh,
        currentPage: this.data.page,
        currentPhotosCount: this.data.photos.length
      })

      // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
      let photosData = []
      if (response.items) {
        photosData = response.items
      } else if (response.photos) {
        photosData = response.photos
      } else if (Array.isArray(response)) {
        photosData = response
      } else {
        console.warn('æœªçŸ¥çš„ç…§ç‰‡APIå“åº”æ ¼å¼:', response)
        photosData = []
      }

      const photos = this.processPhotosData(photosData)
      
      console.log('å¤„ç†åŽçš„ç…§ç‰‡æ•°æ®:', {
        photos,
        photosCount: photos.length,
        firstPhotoUrls: photos[0] ? {
          thumbnailUrl: photos[0].thumbnailUrl,
          fullUrl: photos[0].fullUrl
        } : null
      })
      
      const newPhotos = isRefresh ? photos : [...this.data.photos, ...photos]
      
      this.setData({
        photos: newPhotos,
        loading: false,
        error: false,
        hasMore: response.pages ? response.pages > (isRefresh ? 1 : this.data.page) : false,
        page: isRefresh ? 2 : this.data.page + 1
      })
      
      // ç¼“å­˜ç…§ç‰‡æ•°æ®ï¼ˆåªç¼“å­˜å®Œæ•´çš„ç¬¬ä¸€é¡µæ•°æ®ï¼‰
      if (isRefresh || this.data.page === 2) {
        app.cacheManager.setPhotosCache(this.data.albumId, newPhotos)
        console.log('ðŸ’¾ ç…§ç‰‡æ•°æ®å·²ç¼“å­˜')
      }
      
    } catch (error) {
      console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:', error)
      this.setData({ 
        loading: false, 
        error: true 
      })
      
      if (!isRefresh) {
        app.showError('åŠ è½½ç…§ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    }
  },

  // åŠ è½½æ›´å¤šç…§ç‰‡
  async loadMorePhotos() {
    await this.loadPhotos(false)
  },

  // å¤„ç†ç…§ç‰‡æ•°æ®
  processPhotosData(photos) {
    return photos.map(photo => {
      // å¤„ç†å›¾ç‰‡URLï¼Œç¡®ä¿ä½¿ç”¨å®Œæ•´çš„URL
      const baseUrl = getApp().globalData.imageBaseUrl || 'http://localhost:8000'
      let fullUrl = photo.url
      let thumbnailUrl = photo.thumbnail_url || photo.url
      
      // å¦‚æžœURLä¸æ˜¯å®Œæ•´çš„HTTP URLï¼Œåˆ™æ·»åŠ baseUrl
      if (fullUrl && !fullUrl.startsWith('http')) {
        fullUrl = baseUrl + fullUrl
      }
      if (thumbnailUrl && !thumbnailUrl.startsWith('http')) {
        thumbnailUrl = baseUrl + thumbnailUrl
      }
      
      return {
        ...photo,
        thumbnailUrl,
        fullUrl,
        formattedSize: this.formatFileSize(photo.file_size),
        formattedDate: this.formatDate(photo.created_at)
      }
    })
  },

  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  formatFileSize(bytes) {
    if (!bytes) return 'æœªçŸ¥'
    
    const sizes = ['B', 'KB', 'MB', 'GB']
    let i = 0
    let size = bytes
    
    while (size >= 1024 && i < sizes.length - 1) {
      size /= 1024
      i++
    }
    
    return `${size.toFixed(i === 0 ? 0 : 1)}${sizes[i]}`
  },

  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(dateString) {
    if (!dateString) return ''
    
    const date = new Date(dateString)
    const now = new Date()
    const diffTime = now - date
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
    
    if (diffDays === 0) {
      return 'ä»Šå¤©'
    } else if (diffDays === 1) {
      return 'æ˜¨å¤©'
    } else if (diffDays < 7) {
      return `${diffDays}å¤©å‰`
    } else {
      return date.toLocaleDateString('zh-CN')
    }
  },

  // é¢„è§ˆç…§ç‰‡
  onPhotoTap(e) {
    const index = e.currentTarget.dataset.index
    const urls = this.data.photos.map(photo => photo.fullUrl).filter(url => url) // è¿‡æ»¤ç©ºURL
    
    console.log('é¢„è§ˆç…§ç‰‡:', {
      index,
      totalPhotos: this.data.photos.length,
      urls: urls,
      currentUrl: urls[index]
    })
    
    this.setData({ previewIndex: index })
    
    if (urls.length > 0 && urls[index]) {
      wx.previewImage({
        urls,
        current: urls[index],
        success: () => {
          console.log('å›¾ç‰‡é¢„è§ˆæˆåŠŸ')
        },
        fail: (error) => {
          console.error('é¢„è§ˆå›¾ç‰‡å¤±è´¥:', error)
          app.showError('é¢„è§ˆå¤±è´¥: ' + (error.errMsg || 'æœªçŸ¥é”™è¯¯'))
        }
      })
    } else {
      console.error('æ²¡æœ‰å¯é¢„è§ˆçš„å›¾ç‰‡URL')
      app.showError('å›¾ç‰‡èµ„æºä¸å¯ç”¨')
    }
  },

  // é•¿æŒ‰ç…§ç‰‡èœå•
  onPhotoLongPress(e) {
    const photo = e.currentTarget.dataset.photo
    
    wx.showActionSheet({
      itemList: ['ä¿å­˜åˆ°ç›¸å†Œ', 'åˆ†äº«ç»™æœ‹å‹', 'æŸ¥çœ‹è¯¦æƒ…'],
      success: (res) => {
        switch (res.tapIndex) {
          case 0:
            this.savePhoto(photo)
            break
          case 1:
            this.sharePhoto(photo)
            break
          case 2:
            this.showPhotoDetail(photo)
            break
        }
      }
    })
  },

  // ä¿å­˜ç…§ç‰‡åˆ°ç³»ç»Ÿç›¸å†Œ
  async savePhoto(photo) {
    try {
      // å…ˆä¸‹è½½å›¾ç‰‡
      const res = await wx.downloadFile({
        url: photo.fullUrl
      })
      
      if (res.statusCode === 200) {
        // ä¿å­˜åˆ°ç³»ç»Ÿç›¸å†Œ
        await wx.saveImageToPhotosAlbum({
          filePath: res.tempFilePath
        })
        app.showSuccess('ä¿å­˜æˆåŠŸ')
      } else {
        throw new Error('ä¸‹è½½å¤±è´¥')
      }
    } catch (error) {
      console.error('ä¿å­˜ç…§ç‰‡å¤±è´¥:', error)
      
      if (error.errMsg && error.errMsg.includes('auth')) {
        // æƒé™é—®é¢˜
        wx.showModal({
          title: 'éœ€è¦æŽˆæƒ',
          content: 'ä¿å­˜å›¾ç‰‡éœ€è¦è®¿é—®æ‚¨çš„ç›¸å†Œæƒé™',
          success: (res) => {
            if (res.confirm) {
              wx.openSetting()
            }
          }
        })
      } else {
        app.showError('ä¿å­˜å¤±è´¥')
      }
    }
  },

  // åˆ†äº«ç…§ç‰‡
  sharePhoto(photo) {
    // è¿™é‡Œå¯ä»¥å®žçŽ°åˆ†äº«é€»è¾‘
    app.showSuccess('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­')
  },

  // æ˜¾ç¤ºç…§ç‰‡è¯¦æƒ…
  showPhotoDetail(photo) {
    const detailInfo = [
      `æ–‡ä»¶å: ${photo.original_filename || 'æœªçŸ¥'}`,
      `å°ºå¯¸: ${photo.width && photo.height ? `${photo.width}Ã—${photo.height}` : 'æœªçŸ¥'}`,
      `å¤§å°: ${this.formatFileSize(photo.file_size)}`,
      `ä¸Šä¼ æ—¶é—´: ${this.formatDate(photo.created_at)}`,
    ]
    
    if (photo.description) {
      detailInfo.unshift(`æè¿°: ${photo.description}`)
    }
    
    wx.showModal({
      title: 'ç…§ç‰‡è¯¦æƒ…',
      content: detailInfo.join('\n'),
      showCancel: false,
      confirmText: 'çŸ¥é“äº†'
    })
  },

  // æ˜¾ç¤ºæŽ’åºé€‰é¡¹
  showSortOptions() {
    this.setData({ showSortModal: true })
  },

  // éšè—æŽ’åºé€‰é¡¹
  hideSortModal() {
    this.setData({ showSortModal: false })
  },

  // é€‰æ‹©æŽ’åºæ–¹å¼
  onSortSelect(e) {
    const sortKey = e.currentTarget.dataset.sort
    
    if (sortKey !== this.data.currentSort) {
      this.setData({ 
        currentSort: sortKey,
        page: 1,
        hasMore: true,
        showSortModal: false
      })
      this.loadPhotos(true)
    } else {
      this.hideSortModal()
    }
  },

  // é‡è¯•åŠ è½½
  onRetry() {
    this.setData({ page: 1, hasMore: true })
    this.loadPhotos()
  },

  // åˆ†äº«ç›¸å†Œ
  onShareAppMessage() {
    return {
      title: `ç›¸å†Œ: ${this.data.albumName}`,
      path: `/pages/album/album?albumId=${this.data.albumId}&albumName=${encodeURIComponent(this.data.albumName)}`,
      imageUrl: this.data.photos.length > 0 ? this.data.photos[0].thumbnailUrl : '/images/share-cover.png'
    }
  }
}) 